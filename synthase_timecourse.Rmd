---
title: "Synthase expression time course"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

# Synthase expression time course
I want to make a plot where time in weeks is on the  x axis and pfam00765 presence or absence is on the y axis. I will use the metatranscriptomes from each week aligned to the 31/32 and Acidovorax. 

Go to IMG/JGI, then OMICS > RNAseq, search for "Lake Washington" and select the number link under the "Total RNA seq data sets tab" in the row corresponding to the study: "Freshwater sediment methanotrophic microbial communities from Lake Washington under simulated oxygen tension" (will be 963 or so studies).

I am only interested in the metatranscriptome data sets aligned to either Acidovorax or M. tundripaludum 31/32, so I will sort all the data sets by filtering the column based on one of these reference data sets. Then click "Select All" and go to the "Multiple sample analysis" tab in gray on the same page. Then keep all of the standard parameters and click "Gene expression summary". Then "Select All" rows in the resulting table and Export. Copy and paste the results from the downloaded text file into excel to save as a csv or xlxs file. Open that file.

Search for "homoserine lactone" and in the "Gene product" column. Save the rows that correspond to these genes and save them in a new xlxs and transpose them so study names are the row names and coverage is the value. The experimental data is saved in the long title names for each row and is not easy to sort, so we will make new columns in our table that pulls out the metadata for each sample. 

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
```

```{r}
# for editing theme
my_theme <- theme_bw() +
        theme(text=element_text(size = 12),
        axis.text.x=element_text(size=12, color = "black"), 
        axis.text.y = element_text(size=12, color = "black"),
        title = element_text(size = 12, color = "black"), 
        panel.grid.minor = element_blank(), 
        element_line(linewidth = 1, colour = "black")
                )
```


```{r}
# Load the data
coverage <- read.csv("31-32_MTX_pfam0765_coverage.csv")

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ # Default to NA character vector
  
  if(str_detect(name, "Sediment Metatranscriptome")) {
    matches <- str_match(name, "Sediment Metatranscriptome (\\d+)_([A-Z0-9]+)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name # Default case
  }
  
  # Replace dashes and spaces with underscores for all nicknames
  nickname <- str_replace_all(nickname, "[- ]", "_")
  
  return(nickname)
}

# Then apply this function to your dataframe
coverage$Nickname <- sapply(coverage$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage <- coverage %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "31-32"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage, "31-32_MTX_pfam0765_coverage_metadata.csv", row.names = TRUE)
```

Okay now my dataframe looks good and I can organize everything by the experimental details. 
Let's make a plot of the normalized coverage of pfam0765 (homoserine lactone synthetase) over time for metatranscriptome datasets aligned to the 31/32 genome. 

```{r}
# separate raw couts from normalized coverage
raw <- coverage %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm <- coverage %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW <- norm %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))

LOW <- norm %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))

# Calculate averages for each week for the HOW data
HOW_avg <- HOW %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "31-32") 

# Calculate averages for each week for the LOW data
LOW_avg <- LOW %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE)) %>%  
  mutate(genome = "31-32") 

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "31/32",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```
For 31/32, the high initial oxygen samples had very low expression of the homoserine lactone synthetase for weeks 4-10 (oxic conditions), then as soon as the oxygen tension was switched after week 10 (black vertical line), the same samples now had very high increases of expression of this synthetase. For low oxygen conditions, the expression was steady and a bit higher than HO weeks at the same time points, but then peaked at the late weeks 9 and 10, when conditions wer still hypoxic. As soon as the switch happened and these samples had oxygen, the expression immediately dropped and stayed very low. 
 


Now do this same process for Acidovorax and the "autoinducer synthase" product.

```{r}
# Load the data
coverage_acido <- read.csv("acidovorax_MT_synthase_coverage.csv")

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ # Default to NA character vector
  
  if(str_detect(name, "Sediment Metatranscriptome")) {
    matches <- str_match(name, "Sediment Metatranscriptome (\\d+)_([A-Z0-9]+)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name # Default case
  }
  
  # Replace dashes and spaces with underscores for all nicknames
  nickname <- str_replace_all(nickname, "[- ]", "_")
  
  return(nickname)
}

# Then apply this function to your dataframe
coverage_acido$Nickname <- sapply(coverage_acido$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage_acido <- coverage_acido %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "Acidovorax"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage_acido, "acidovorax_MTX_syntase_coverage_metadata.csv", row.names = TRUE)
```

Plotting Acidovorax autoinducer synthase expression time course: 
```{r}
# separate raw couts from normalized coverage
raw_a <- coverage_acido %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_a <- coverage_acido %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW_a <- norm_a %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric 
HOW_a$coverage <- as.numeric(as.character(HOW_a$coverage))


LOW_a <- norm_a %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric if it's not already
LOW_a$coverage <- as.numeric(as.character(LOW_a$coverage))


# Calculate averages for each week for the HOW data
HOW_avg_a <- HOW_a %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage)) %>%  
  mutate(genome = "Acidovorax") 

# Calculate averages for each week for the LOW data
LOW_avg_a <- LOW_a %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "Acidovorax") 

# plot just the points 
ggplot() + 
  geom_point(data = HOW_a, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_a, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "Acidovorax",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW_a, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_a, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg_a, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg_a, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "Acidovorax",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```
For Acidovorax, in the low oxygen conditions, there were only three individual samples that had any expression greater than 0: MT2_LOW4, MT28_LOW6, and MT97_LOW12. In high oxygen samples, there were more replicates that had expression of the synthase, but it was still less than half of all replicates. 


Want to combine the 31/32 and Acidovorax average expressions:
```{r}
ggplot() + 
  geom_line(data = HOW_avg_a, aes(x = week, y = average_coverage, color = "HOW_a"), linetype = "dotted", size = 1) +
  geom_line(data = LOW_avg_a, aes(x = week, y = average_coverage, color = "LOW_a"), linetype = "dotted", size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW"), size = 1) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","LOW_a" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax","LOW_a"= "Low O2: Acidovorax","HOW" = "High O2: 31/32", "LOW" = "Low O2: 31/32")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme

#log(average coverage)
ggplot() + 
  geom_line(data = HOW_avg_a, aes(x = week, y = log(average_coverage), color = "HOW_a"), linetype = "dotted", size = 1) +
  geom_line(data = LOW_avg_a, aes(x = week, y = log(average_coverage), color = "LOW_a"), linetype = "dotted", size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = log(average_coverage), color = "HOW"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = log(average_coverage), color = "LOW"), size = 1) +
  xlab('week') +
  ylab('log(coverage)') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","LOW_a" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax","LOW_a"= "Low O2: Acidovorax","HOW" = "High O2: 31/32", "LOW" = "Low O2: 31/32")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```


## Normalize 31/32 to RpoS
There's not an obvious pattern between the acidovorax and the 31/32 synthase expression, so let's normalize each to a housekeeping gene and do the comparison again. 

```{r}
# Load the data and remove the first two columns
coverage <- read.csv("31-32_MTX_coverage.csv", row.names = 1)[, -c(1, 2)]

# Capture original row and column names
original_row_names <- rownames(coverage)
original_column_names <- colnames(coverage)

# Convert all data to numeric
coverage[] <- lapply(coverage, function(x) as.numeric(as.character(x)))

# Extract and check the normalization row
normalization_values <- as.numeric(coverage["2574194336", ])
normalization_values <- unlist(normalization_values)  # Convert list to vector

# Normalize each column
normalized_df <- sapply(seq_along(coverage), function(i) coverage[,i] / normalization_values[i])
normalized_df <- as.data.frame(normalized_df)

# Reassign the original row and column names
rownames(normalized_df) <- original_row_names
colnames(normalized_df) <- original_column_names
```

```{r}
# Save the modified dataframe
write.csv(normalized_df, "31-32_MTX_coverage_rpoS_normalized.csv", row.names = TRUE)
```

### 31/32 synthase time course
```{r}
# Load the data
coverage <- read.csv("31-32_MTX_pfam0765_normalized_coverage.csv")

# replace . with _
coverage$sample <- gsub("\\.", "_", coverage$sample)

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ 
  if(str_detect(name, "Sediment_Metatranscriptome")) {
    matches <- str_match(name, "Sediment_Metatranscriptome_(\\d+)_([A-Z]+\\d*)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw_Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name 
    }
  nickname <- str_replace_all(nickname, "[- ]", "_")
  return(nickname)
}

# Then apply this function to your dataframe
coverage$Nickname <- sapply(coverage$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage <- coverage %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "31-32"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage, "31-32_MTX_pfam0765_coverage_metadata_normalized.csv", row.names = TRUE)
```

Okay now my dataframe looks good and I can organize everything by the experimental details. 
Let's make a plot of the normalized coverage of pfam0765 (homoserine lactone synthetase) over time for metatranscriptome datasets aligned to the 31/32 genome. 

```{r}
# separate raw couts from normalized coverage
raw <- coverage %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm <- coverage %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW <- norm %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))

LOW <- norm %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))

# Calculate averages for each week for the HOW data
HOW_avg <- HOW %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "31-32") 

# Calculate averages for each week for the LOW data
LOW_avg <- LOW %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE)) %>%  
  mutate(genome = "31-32") 

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('Coverage normalized to rpoS abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "31/32",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```
### 31/32 synthase time course (raw counts)
```{r}
# Load the data
coverage <- read.csv("31-32_MTX_pfam0765_coverage_metadata_normalized.csv")
```


```{r}
# separate raw couts from normalized coverage
raw <- coverage %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm <- coverage %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW <- raw %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))

LOW <- raw %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))

# Calculate averages for each week for the HOW data
HOW_avg <- HOW %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "31-32") 

# Calculate averages for each week for the LOW data
LOW_avg <- LOW %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE)) %>%  
  mutate(genome = "31-32") 

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('Raw counts normalized to rpoS abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "31/32",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

## Normalize Acidovorax to RpoD
There's not an obvious pattern between the acidovorax and the 31/32 synthase expression, so let's normalize each to a housekeeping gene and do the comparison again. 

```{r}
# Load the data and remove the first two columns
coverage <- read.csv("acidovorax_MTX_coverage.csv", row.names = 1)[, -c(1, 2)]

# Capture original row and column names
original_row_names <- rownames(coverage)
original_column_names <- colnames(coverage)

# Convert all data to numeric
coverage[] <- lapply(coverage, function(x) as.numeric(as.character(x)))

# Extract and check the normalization row
normalization_values <- as.numeric(coverage["2548500212", ])
normalization_values <- unlist(normalization_values)  # Convert list to vector

# Normalize each column
normalized_df <- sapply(seq_along(coverage), function(i) coverage[,i] / normalization_values[i])
normalized_df <- as.data.frame(normalized_df)

# Reassign the original row and column names
rownames(normalized_df) <- original_row_names
colnames(normalized_df) <- original_column_names
```

```{r}
# Save the modified dataframe
write.csv(normalized_df, "acidovorax_MTX_coverage_rpoD_normalized.csv", row.names = TRUE)
```

### Acidovorax synthase time course
```{r}
# Load the data
coverage_acido <- read.csv("acidovorax_MTX_synthase_coverage_normalized.csv")

# replace . with _
coverage_acido$sample <- gsub("\\.", "_", coverage_acido$sample)

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ 
  if(str_detect(name, "Sediment_Metatranscriptome")) {
    matches <- str_match(name, "Sediment_Metatranscriptome_(\\d+)_([A-Z]+\\d*)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw_Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name 
    }
  nickname <- str_replace_all(nickname, "[- ]", "_")
  return(nickname)
}

# Then apply this function to your dataframe
coverage_acido$Nickname <- sapply(coverage_acido$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage_acido <- coverage_acido %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "Acidovorax"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage_acido, "acidovorax_MTX_synthase_coverage_normalized_metadata.csv", row.names = TRUE)
```

Plotting Acidovorax autoinducer synthase expression time course: 
```{r}
# separate raw couts from normalized coverage
raw_a <- coverage_acido %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_a <- coverage_acido %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW_a <- norm_a %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric 
HOW_a$coverage <- as.numeric(as.character(HOW_a$coverage))


LOW_a <- norm_a %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric if it's not already
LOW_a$coverage <- as.numeric(as.character(LOW_a$coverage))


# Calculate averages for each week for the HOW data
HOW_avg_a <- HOW_a %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage)) %>%  
  mutate(genome = "Acidovorax") 

# Calculate averages for each week for the LOW data
LOW_avg_a <- LOW_a %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "Acidovorax") 

# plot just the points 
ggplot() + 
  geom_point(data = HOW_a, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_a, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "Acidovorax",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW_a, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_a, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg_a, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg_a, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('Coverage normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "Acidovorax",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

##Normalized 31/32 and Acidovorax time course
```{r}
ggplot() + 
  geom_line(data = HOW_avg_a, aes(x = week, y = average_coverage, color = "HOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = LOW_avg_a, aes(x = week, y = average_coverage, color = "LOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW"), size = 1) +
  xlab('week') +
  ylab('Normalized coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","LOW_a" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax","LOW_a"= "Low O2: Acidovorax","HOW" = "High O2: 31/32", 
                                "LOW" = "Low O2: 31/32")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  my_theme

#log(average coverage)
ggplot() + 
  geom_line(data = HOW_avg_a, aes(x = week, y = average_coverage, color = "HOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = LOW_avg_a, aes(x = week, y = average_coverage, color = "LOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW"), size = 1) +
  xlab('week') +
  ylab('Raw counts normalized to housekeeping gene') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","LOW_a" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax","LOW_a"= "Low O2: Acidovorax","HOW" = "High O2: 31/32", 
                                "LOW" = "Low O2: 31/32")) +
  geom_vline(xintercept = c(10.1)) +
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE)) +
  my_theme
```



## Acidovorax synthase vs. receptor time course

```{r}
# load the data
coverage_synth <- read.csv("acidovorax_MTX_synthase_coverage_normalized_metadata.csv")
coverage_recept <- read.csv("acidovorax_MTX_receptor_coverage_normalized_metadata.csv")

# separate raw counts from normalized coverage
raw_synth <- coverage_synth %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_synth <- coverage_synth %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

raw_recept <- coverage_recept %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_recept <- coverage_recept %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the raw coverage data, separate high and low oxygen conditions
HOW_synth <- raw_synth %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric 
HOW_synth$coverage <- as.numeric(as.character(HOW_synth$coverage))

LOW_synth <- raw_synth %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric if it's not already
LOW_synth$coverage <- as.numeric(as.character(LOW_synth$coverage))


HOW_recept <- raw_recept %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric 
HOW_recept$coverage <- as.numeric(as.character(HOW_recept$coverage))

LOW_recept <- raw_recept %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric if it's not already
LOW_recept$coverage <- as.numeric(as.character(LOW_recept$coverage))

# Calculate averages for each week for the HOW data
HOW_avg_synth <- HOW_synth %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage)) %>%  
  mutate(genome = "Acidovorax")

HOW_avg_recept <- HOW_recept %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage)) %>%  
  mutate(genome = "Acidovorax") 

# Calculate averages for each week for the LOW data
LOW_avg_synth <- LOW_synth %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "Acidovorax") 

LOW_avg_recept <- LOW_recept %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "Acidovorax")

# Plot points and add average lines
ggplot() + 
  geom_line(data = HOW_avg_recept, aes(x = week, y = average_coverage, color = "HOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = LOW_avg_recept, aes(x = week, y = average_coverage, color = "LOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = HOW_avg_synth, aes(x = week, y = average_coverage, color = "HOW"), size = 1) +
  geom_line(data = LOW_avg_synth, aes(x = week, y = average_coverage, color = "LOW"), size = 1) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","LOW_a" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: receptor","LOW_a"= "Low O2: receptor","HOW" = "High O2: synthase", 
                                "LOW" = "Low O2: synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  my_theme
```

##Normalized 31/32 synthase and Acidovorax receptor time course
```{r}
# 31/32 synthase, acidovorax synthase, acidovorax receptor for HO and LO
ggplot() + 
  geom_line(data = HOW_avg_recept, aes(x = week, y = average_coverage, color = "HOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = LOW_avg_recept, aes(x = week, y = average_coverage, color = "LOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = HOW_avg_synth, aes(x = week, y = average_coverage, color = "HOW"), size = 1) +
  geom_line(data = LOW_avg_synth, aes(x = week, y = average_coverage, color = "LOW"), size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW3"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW3"), size = 1) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","LOW_a" = "blue","HOW" = "red", "LOW" = "blue", "HOW3" = "black", "LOW3" = "gray"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax receptor","LOW_a"= "Low O2: Acidovorax receptor",
                                "HOW" = "High O2: Acidovorax synthase", "LOW" = "Low O2: Acidovorax synthase", 
                                "HOW3"="High O2: 31/32 synthase", "LOW3" = "Low O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE)) +
  my_theme

# 31/32 synthase, acidovorax synthase, acidovorax receptor for HO
ggplot() + 
  geom_line(data = HOW_avg_recept, aes(x = week, y = average_coverage, color = "HOW_a"), linetype = "dashed", size = 1) +
  geom_line(data = HOW_avg_synth, aes(x = week, y = average_coverage, color = "HOW"), size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = average_coverage, color = "HOW3"), size = 1) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","HOW" = "red", "HOW3" = "black"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax receptor",
                                "HOW" = "High O2: Acidovorax synthase",
                                "HOW3"="High O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE)) +
  my_theme

# 31/32 synthase, acidovorax synthase, acidovorax receptor for LO
ggplot() + 
  
  geom_line(data = LOW_avg_recept, aes(x = week, y = average_coverage, color = "LOW_a"), linetype = "dashed", size = 1) +

  geom_line(data = LOW_avg_synth, aes(x = week, y = average_coverage, color = "LOW"), size = 1) +
 
  geom_line(data = LOW_avg, aes(x = week, y = average_coverage, color = "LOW3"), size = 1) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a" = "blue","LOW" = "blue","LOW3" = "gray"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax receptor",
                                "LOW" = "Low O2: Acidovorax synthase", 
                                "LOW3" = "Low O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE)) +
  my_theme

```


```{r}
# plotting with points
# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", HOW_recept$sample_ID))) {
  HOW_recept$sample_ID <- as.numeric(HOW_recept$sample_ID)
  HOW_recept$sample_ID <- sprintf("%02d", HOW_recept$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", HOW_recept$week))) {
  HOW_recept$week <- as.numeric(HOW_recept$week)
  HOW_recept$week <- sprintf("%02d", HOW_recept$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

HOW_recept$sample_ID <- str_pad(HOW_recept$sample_ID, width = 3, pad = "0")
HOW_recept$week <- str_pad(HOW_recept$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
HOW_recept_rep <- HOW_recept %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
HOW_recept_rep$week <- as.numeric(as.character(HOW_recept_rep$week))

# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", HOW_synth$sample_ID))) {
  HOW_synth$sample_ID <- as.numeric(HOW_synth$sample_ID)
  HOW_synth$sample_ID <- sprintf("%02d", HOW_synth$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", HOW_synth$week))) {
  HOW_synth$week <- as.numeric(HOW_synth$week)
  HOW_synth$week <- sprintf("%02d", HOW_synth$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

HOW_synth$sample_ID <- str_pad(HOW_synth$sample_ID, width = 3, pad = "0")
HOW_synth$week <- str_pad(HOW_synth$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
HOW_synth_rep <- HOW_synth %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
HOW_synth_rep$week <- as.numeric(as.character(HOW_synth_rep$week))

# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", HOW$sample_ID))) {
  HOW$sample_ID <- as.numeric(HOW$sample_ID)
  HOW$sample_ID <- sprintf("%02d", HOW$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", HOW$week))) {
  HOW$week <- as.numeric(HOW$week)
  HOW$week <- sprintf("%02d", HOW$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

HOW$sample_ID <- str_pad(HOW$sample_ID, width = 3, pad = "0")
HOW$week <- str_pad(HOW$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
HOW_rep <- HOW %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
HOW_rep$week <- as.numeric(as.character(HOW_rep$week))

# plot
ggplot() + 
  geom_point(data = HOW_recept_rep, aes(x = week, y = coverage, color = "HOW_a", shape = replicate), size = 3) +
  geom_point(data = HOW_synth_rep, aes(x = week, y = coverage, color = "HOW", shape = replicate), size = 3) +
  geom_point(data = HOW_rep, aes(x = week, y = coverage, color = "HOW3", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","HOW" = "orange", "HOW3" = "black"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax receptor",
                                "HOW" = "High O2: Acidovorax synthase",
                                "HOW3"="High O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE), limits = c(0.001, 30)) +
  my_theme


# plot with acidovorax only
ggplot() + 
  geom_point(data = HOW_recept_rep, aes(x = week, y = coverage, color = "HOW_a", shape = replicate), size = 3) +
  geom_point(data = HOW_synth_rep, aes(x = week, y = coverage, color = "HOW", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_a"= "red","HOW" = "orange"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_a"= "High O2: Acidovorax receptor",
                                "HOW" = "High O2: Acidovorax synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE), limits = c(0.001,30)) +
  my_theme
```

```{r}
# plotting with points
# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", LOW_recept$sample_ID))) {
  LOW_recept$sample_ID <- as.numeric(LOW_recept$sample_ID)
  LOW_recept$sample_ID <- sprintf("%02d", LOW_recept$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", LOW_recept$week))) {
  LOW_recept$week <- as.numeric(LOW_recept$week)
  LOW_recept$week <- sprintf("%02d", LOW_recept$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

LOW_recept$sample_ID <- str_pad(LOW_recept$sample_ID, width = 3, pad = "0")
LOW_recept$week <- str_pad(LOW_recept$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
LOW_recept_rep <- LOW_recept %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
LOW_recept_rep$week <- as.numeric(as.character(LOW_recept_rep$week))

# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", LOW_synth$sample_ID))) {
  LOW_synth$sample_ID <- as.numeric(LOW_synth$sample_ID)
  LOW_synth$sample_ID <- sprintf("%02d", LOW_synth$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", LOW_synth$week))) {
  LOW_synth$week <- as.numeric(LOW_synth$week)
  LOW_synth$week <- sprintf("%02d", LOW_synth$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

LOW_synth$sample_ID <- str_pad(LOW_synth$sample_ID, width = 3, pad = "0")
LOW_synth$week <- str_pad(LOW_synth$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
LOW_synth_rep <- LOW_synth %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
LOW_synth_rep$week <- as.numeric(as.character(LOW_synth_rep$week))

# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", LOW$sample_ID))) {
  LOW$sample_ID <- as.numeric(LOW$sample_ID)
  LOW$sample_ID <- sprintf("%02d", LOW$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", LOW$week))) {
  LOW$week <- as.numeric(LOW$week)
  LOW$week <- sprintf("%02d", LOW$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

LOW$sample_ID <- str_pad(LOW$sample_ID, width = 3, pad = "0")
LOW$week <- str_pad(LOW$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
LOW_rep <- LOW %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
LOW_rep$week <- as.numeric(as.character(LOW_rep$week))

# plot
ggplot() + 
  geom_point(data = LOW_recept_rep, aes(x = week, y = coverage, color = "LOW_a", shape = replicate), size = 3) +
  geom_point(data = LOW_synth_rep, aes(x = week, y = coverage, color = "LOW", shape = replicate), size = 3) +
  geom_point(data = LOW_rep, aes(x = week, y = coverage, color = "LOW3", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a"= "blue","LOW" = "cornflowerblue", "LOW3" = "black"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax receptor",
                                "LOW" = "Low O2: Acidovorax synthase",
                                "LOW3"="Low O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE),  limits = c(0.001,30)) +
  my_theme

# plot with acidovorax only
ggplot() + 
  geom_point(data = LOW_recept_rep, aes(x = week, y = coverage, color = "LOW_a", shape = replicate), size = 3) +
  geom_point(data = LOW_synth_rep, aes(x = week, y = coverage, color = "LOW", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a"= "blue","LOW" = "cornflowerblue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax receptor",
                                "LOW" = "Low O2: Acidovorax synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE), limits = c(0.001,30)) +
  my_theme
```
## Acidovorax flagellin1 + synthase time course
```{r}
# Load the data
coverage_flag <- read.csv("acidovorax_MTX_flagellin2548501241_coverage_normalized.csv")

# replace . with _
coverage_flag$sample <- gsub("\\.", "_", coverage_flag$sample)

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ 
  if(str_detect(name, "Sediment_Metatranscriptome")) {
    matches <- str_match(name, "Sediment_Metatranscriptome_(\\d+)_([A-Z]+\\d*)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw_Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name 
    }
  nickname <- str_replace_all(nickname, "[- ]", "_")
  return(nickname)
}

# Then apply this function to your dataframe
coverage_flag$Nickname <- sapply(coverage_flag$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage_flag <- coverage_flag %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "Acidovorax"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage_flag, "acidovorax_MTX_flagellin2548501241_coverage_normalized_metadata.csv", row.names = TRUE)
```

Plotting Acidovorax autoinducer synthase expression time course: 
```{r}
# separate raw couts from normalized coverage
raw_flag <- coverage_flag %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_flag <- coverage_flag %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW_flag <- raw_flag %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric 
HOW_flag$coverage <- as.numeric(as.character(HOW_flag$coverage))


LOW_flag <- raw_flag %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric if it's not already
LOW_flag$coverage <- as.numeric(as.character(LOW_flag$coverage))


# Calculate averages for each week for the HOW data
HOW_avg_flag <- HOW_flag %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage)) %>%  
  mutate(genome = "Acidovorax") 

# Calculate averages for each week for the LOW data
LOW_avg_flag <- LOW_flag %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "Acidovorax") 


# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW_flag, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_flag, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg_flag, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg_flag, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('flagellin raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "Acidovorax",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

```{r}
# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", LOW_flag$sample_ID))) {
  LOW_flag$sample_ID <- as.numeric(LOW_flag$sample_ID)
  LOW_flag$sample_ID <- sprintf("%02d", LOW_flag$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", LOW_flag$week))) {
  LOW_flag$week <- as.numeric(LOW_flag$week)
  LOW_flag$week <- sprintf("%02d", LOW_flag$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

LOW_flag$sample_ID <- str_pad(LOW_flag$sample_ID, width = 3, pad = "0")
LOW_flag$week <- str_pad(LOW_flag$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
LOW_flag_rep <- LOW_flag %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
LOW_flag_rep$week <- as.numeric(as.character(LOW_flag_rep$week))

# plot that includes the synthase
ggplot() + 
  geom_point(data = LOW_flag_rep, aes(x = week, y = coverage, color = "LOW_a", shape = replicate), size = 3) +
  geom_point(data = LOW_synth_rep, aes(x = week, y = coverage, color = "LOW", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a"= "blue","LOW" = "cornflowerblue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax flagellin",
                                "LOW" = "Low O2: Acidovorax synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE), limits = c(0.001,30)) +
  my_theme

# plot with 31/32 synthase
# plot
ggplot() + 
  geom_point(data = LOW_flag_rep, aes(x = week, y = coverage, color = "LOW_a", shape = replicate), size = 3) +
  geom_point(data = LOW_synth_rep, aes(x = week, y = coverage, color = "LOW", shape = replicate), size = 3) +
  geom_point(data = LOW_rep, aes(x = week, y = coverage, color = "LOW3", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a"= "blue","LOW" = "cornflowerblue", "LOW3" = "black"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax flagellin",
                                "LOW" = "Low O2: Acidovorax synthase",
                                "LOW3"="Low O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE),  limits = c(0.001,30)) +
  my_theme
```
## Acidovorax flagellin2 + synthase time course
```{r}
# Load the data
coverage_flag2 <- read.csv("acidovorax_MTX_flagellin2548498152_coverage_normalized.csv")

# replace . with _
coverage_flag2$sample <- gsub("\\.", "_", coverage_flag2$sample)

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ 
  if(str_detect(name, "Sediment_Metatranscriptome")) {
    matches <- str_match(name, "Sediment_Metatranscriptome_(\\d+)_([A-Z]+\\d*)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw_Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name 
    }
  nickname <- str_replace_all(nickname, "[- ]", "_")
  return(nickname)
}

# Then apply this function to your dataframe
coverage_flag2$Nickname <- sapply(coverage_flag2$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage_flag2 <- coverage_flag2 %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "Acidovorax"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage_flag2, "acidovorax_MTX_flagellin2548498152_coverage_normalized_metadata.csv", row.names = TRUE)
```

Plotting Acidovorax autoinducer synthase expression time course: 
```{r}
# separate raw couts from normalized coverage
raw_flag2 <- coverage_flag2 %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_flag2 <- coverage_flag2 %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW_flag2 <- raw_flag2 %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric 
HOW_flag2$coverage <- as.numeric(as.character(HOW_flag2$coverage))


LOW_flag2 <- raw_flag2 %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
# Convert coverage to numeric if it's not already
LOW_flag2$coverage <- as.numeric(as.character(LOW_flag2$coverage))


# Calculate averages for each week for the HOW data
HOW_avg_flag2 <- HOW_flag2 %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage)) %>%  
  mutate(genome = "Acidovorax") 

# Calculate averages for each week for the LOW data
LOW_avg_flag2 <- LOW_flag2 %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "Acidovorax") 


# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW_flag2, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_flag2, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg_flag2, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg_flag2, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('flagellin2 raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "Acidovorax",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

```{r}
# put a zero in front of single digits
# Convert to numeric only if all values are numbers
if (all(grepl("^[0-9]+$", LOW_flag2$sample_ID))) {
  LOW_flag2$sample_ID <- as.numeric(LOW_flag2$sample_ID)
  LOW_flag2$sample_ID <- sprintf("%02d", LOW_flag2$sample_ID)
} else {
  warning("Not all values in 'sample_ID' are numbers.")
}

# The same for 'week'
if (all(grepl("^[0-9]+$", LOW_flag2$week))) {
  LOW_flag2$week <- as.numeric(LOW_flag2$week)
  LOW_flag2$week <- sprintf("%02d", LOW_flag2$week)
} else {
  warning("Not all values in 'week' are numbers.")
}

LOW_flag2$sample_ID <- str_pad(LOW_flag2$sample_ID, width = 3, pad = "0")
LOW_flag2$week <- str_pad(LOW_flag2$week, width = 2, pad = "0")

# add column with replicate identifiers (A, B, C, D)
LOW_flag2_rep <- LOW_flag2 %>%
  group_by(week) %>%
  arrange(.,sample_ID) %>%
  mutate(replicate = LETTERS[row_number()]) %>%
  ungroup()

#convert week values back to numeric
LOW_flag2_rep$week <- as.numeric(as.character(LOW_flag2_rep$week))

# plot that includes the synthase
ggplot() + 
  geom_point(data = LOW_flag2_rep, aes(x = week, y = coverage, color = "LOW_a", shape = replicate), size = 3) +
  geom_point(data = LOW_synth_rep, aes(x = week, y = coverage, color = "LOW", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a"= "blue","LOW" = "cornflowerblue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax flagellin2",
                                "LOW" = "Low O2: Acidovorax synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE), limits = c(0.001,30)) +
  my_theme

# plot with 31/32 synthase
# plot
ggplot() + 
  geom_point(data = LOW_flag2_rep, aes(x = week, y = coverage, color = "LOW_a", shape = replicate), size = 3) +
  geom_point(data = LOW_synth_rep, aes(x = week, y = coverage, color = "LOW", shape = replicate), size = 3) +
  geom_point(data = LOW_rep, aes(x = week, y = coverage, color = "LOW3", shape = replicate), size = 3) +
  xlab('week') +
  ylab('Raw counts normalized to rpoD abundance') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("LOW_a"= "blue","LOW" = "cornflowerblue", "LOW3" = "black"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("LOW_a"= "Low O2: Acidovorax flagellin2",
                                "LOW" = "Low O2: Acidovorax synthase",
                                "LOW3"="Low O2: 31/32 synthase")) +
  geom_vline(xintercept = c(10.1)) + 
  scale_y_continuous(trans='log10', labels = function(x) format(x, scientific = FALSE),  limits = c(0.001,30)) +
  my_theme
```
# All gene correlation between Acidovorax MTX and 31/32 MTX genes
```{r}
# Load the data for both species
Mtund <- read.csv("31-32_MTX_coverage_rpoS_normalized.csv", row.names = 1)
Acido <- read.csv("acidovorax_MTX_coverage_rpoD_normalized.csv", row.names = 1)

# Remove the last 4 digits and the period from the end of the column names in Mtund_other
colnames(Mtund) <- gsub("\\.\\d{4}\\.?$", "", colnames(Mtund))

# Remove the last 4 digits and the period from the end of the column names in Acido_other
colnames(Acido) <- gsub("\\.\\d{4}\\.?$", "", colnames(Acido))


# Filter columns containing "Raw.Count" and those that don't for Mtund
Mtund_raw_count <- Mtund[, grep("Raw.Count", colnames(Mtund))]
Mtund_other <- Mtund[, !grepl("Raw.Count", colnames(Mtund))]

# Filter columns containing "Raw.Count" and those that don't for Acido
Acido_raw_count <- Acido[, grep("Raw.Count", colnames(Acido))]
Acido_other <- Acido[, !grepl("Raw.Count", colnames(Acido))]

# Filter columns containing "LOW" or "HOW"
low_columns <- grep("LOW", colnames(Mtund_other), value = TRUE)
how_columns <- grep("HOW", colnames(Mtund_other), value = TRUE)

Mtund_low <- Mtund_other[, low_columns]
Mtund_how <- Mtund_other[, how_columns]

low_columns <- grep("LOW", colnames(Acido_other), value = TRUE)
how_columns <- grep("HOW", colnames(Acido_other), value = TRUE)

Acido_low <- Acido_other[, low_columns]
Acido_how <- Acido_other[, how_columns]

# Get the common set of column names
common_cols <- intersect(colnames(Mtund_other), colnames(Acido_other))

# Sort the common set of column names alphabetically
sorted_cols <- sort(common_cols)

# Reorder the columns of both data frames
Mtund_other <- Mtund_other %>% select(all_of(sorted_cols))
Acido_other <- Acido_other %>% select(all_of(sorted_cols))

# Convert all values in a dataframe to numeric
Mtund_other[] <- lapply(Mtund_other, as.numeric)
Acido_other[] <- lapply(Acido_other, as.numeric)

# Set the minimum number of non-missing values required for correlation test
min_non_missing <- 3  # Adjust this value as needed

# Initialize a list to store correlation results
correlation_results <- list()

# WARNING: this takes forever
# Loop through each row of the first dataframe
for (i in 1:nrow(Mtund_other)) {
  gene_values_mtund <- as.numeric(Mtund_other[i, ])
  
  # Loop through each row of the second dataframe
  for (j in 1:nrow(Acido_other)) {
    gene_values_acido <- as.numeric(Acido_other[j, ])
    
    # Filter out missing or infinite values
    finite_indices <- is.finite(gene_values_mtund) & is.finite(gene_values_acido)
    
    # Check if there are enough finite observations
    if (sum(finite_indices) >= min_non_missing) {
      # Perform correlation test
      correlation <- cor.test(gene_values_mtund[finite_indices], gene_values_acido[finite_indices])
      
      # Store results in correlation_results list
      correlation_results[[paste("Gene", i, "_vs_Gene", j, sep = "")]] <- list(
        Gene1 = rownames(Mtund_other)[i],
        Gene2 = rownames(Acido_other)[j],
        R_coefficient = correlation$estimate,
        p_value = correlation$p.value
      )
    }
  }
}

# Print correlation results
print(correlation_results)

```

Just try the LuxR receptor from Acidovorax vs. all the 31/32 genes across all experiments. 

```{r}
# Set the minimum number of non-missing values required for correlation test
min_non_missing <- 3  # Adjust this value as needed

# Select the gene from Acido_other to compare against all genes in Mtund_other
gene_acido <- "2548497362"

# Initialize vectors to store correlation results
genes_mtund <- character()
genes_acido <- character()
R_coefficients <- numeric()
p_values <- numeric()

# Loop through each row of Mtund_other
for (i in 1:nrow(Mtund_other)) {
  gene_values_mtund <- as.numeric(Mtund_other[i, ])
  
  # Select the gene values from Acido_other
  gene_values_acido <- as.numeric(Acido_other[gene_acido, ])
  
  # Filter out missing or infinite values
  finite_indices <- is.finite(gene_values_mtund) & is.finite(gene_values_acido)
  
  # Check if there are enough finite observations
  if (sum(finite_indices) >= min_non_missing) {
    # Perform correlation test
    correlation <- cor.test(gene_values_mtund[finite_indices], gene_values_acido[finite_indices])
    
    # Store results
    genes_mtund <- c(genes_mtund, rownames(Mtund_other)[i])
    genes_acido <- c(genes_acido, gene_acido)
    R_coefficients <- c(R_coefficients, correlation$estimate)
    p_values <- c(p_values, correlation$p.value)
  }
}

# Create dataframe for correlation results
correlation_results_df <- data.frame(
  Gene_mtund = genes_mtund,
  Gene_acido = genes_acido,
  R_coefficient = R_coefficients,
  p_value = p_values
)

# Print correlation results dataframe
print(correlation_results_df)

# sort list
Mtun_all <- read.csv("31-32_MTX_coverage.csv", row.names = 1)

# Convert row names to a column in Mtun_all
Mtun_all$Gene_ID <- rownames(Mtun_all)

# Merge significant_results with Mtun_all based on shared values in "Gene ID" and "Gene_mtund"
merged_results <- merge(correlation_results_df, Mtun_all, by.x = "Gene_mtund", by.y = "Gene_ID", all.x = TRUE)

# Filter rows with p-value less than 0.01
significant_results <- subset(merged_results, p_value < 0.01)


```


Do this for high and low oxygen
```{r}
# Get the common set of column names
common_cols_low <- intersect(colnames(Mtund_low), colnames(Acido_low))

# Sort the common set of column names alphabetically
sorted_cols_low <- sort(common_cols_low)

# Reorder the columns of both data frames
Mtund_low <- Mtund_low %>% select(all_of(sorted_cols_low))
Acido_low <- Acido_low %>% select(all_of(sorted_cols_low))

# Convert all values in a dataframe to numeric
Mtund_low[] <- lapply(Mtund_low, as.numeric)
Acido_low[] <- lapply(Acido_low, as.numeric)

# Set the minimum number of non-missing values required for correlation test
min_non_missing <- 3  # Adjust this value as needed

# Select the gene from Acido_other to compare against all genes in Mtund_other
gene_acido_low <- "2548497362"

# Initialize vectors to store correlation results
genes_mtund <- character()
genes_acido <- character()
R_coefficients <- numeric()
p_values <- numeric()

# Loop through each row of Mtund_other
for (i in 1:nrow(Mtund_low)) {
  gene_values_mtund <- as.numeric(Mtund_low[i, ])
  gene_values_acido <- as.numeric(Acido_low[gene_acido_low, ])
  finite_indices <- is.finite(gene_values_mtund) & is.finite(gene_values_acido)
  if (sum(finite_indices) >= min_non_missing) {
    correlation <- cor.test(gene_values_mtund[finite_indices], gene_values_acido[finite_indices])
    genes_mtund <- c(genes_mtund, rownames(Mtund_low)[i])
    genes_acido <- c(genes_acido, gene_acido_low)
    R_coefficients <- c(R_coefficients, correlation$estimate)
    p_values <- c(p_values, correlation$p.value)
  }
}

# Create dataframe for correlation results
correlation_results_low <- data.frame(
  Gene_mtund = genes_mtund,
  Gene_acido = genes_acido,
  R_coefficient = R_coefficients,
  p_value = p_values
)

# sort list
# Merge significant_results with Mtun_all based on shared values in "Gene ID" and "Gene_mtund"
merged_results_low <- merge(correlation_results_low, Mtun_all, by.x = "Gene_mtund", by.y = "Gene_ID", all.x = TRUE)

# Filter rows with p-value less than 0.01
significant_results_low <- subset(merged_results, p_value < 0.01)
```

# correlation between Acidovorax synthase and all other Acidovorax genes.
High oxygen conditions
```{r}
# make data frame with just the Acidovorax synthase gene 2548497361
acido_synth_how <- Acido_how[rownames(Acido_how) == "2548497361", ]

min_non_missing <- 3

# Initialize vectors to store correlation results
genes_acido_synth_how <- character()
genes_acido <- character()
R_coefficients <- numeric()
p_values <- numeric()

# Loop through each row of acido_synth_how
for (i in 1:nrow(acido_synth_how)) {
  gene_values_acido_synth_how <- as.numeric(acido_synth_how[i, ])
  
  # Calculate correlation with each row of Acido_how
  for (j in 1:nrow(Acido_how)) {
    gene_values_acido <- as.numeric(Acido_how[j, ])
    finite_indices <- is.finite(gene_values_acido_synth_how) & is.finite(gene_values_acido)
    
    if (sum(finite_indices) >= min_non_missing) {
      correlation <- cor.test(gene_values_acido_synth_how[finite_indices], gene_values_acido[finite_indices])
      genes_acido_synth_how <- c(genes_acido_synth_how, rownames(acido_synth_how)[i])
      genes_acido <- c(genes_acido, rownames(Acido_how)[j])
      R_coefficients <- c(R_coefficients, correlation$estimate)
      p_values <- c(p_values, correlation$p.value)
    }
  }
}

# Create dataframe for correlation results
correlation_results_how <- data.frame(
  Gene_acido_synth_how = genes_acido_synth_how,
  Gene_acido = genes_acido,
  R_coefficient = R_coefficients,
  p_value = p_values
)

# sort list

Acido_all <- read.csv("acidovorax_MTX_coverage.csv", row.names = 1)

Acido_all$Gene_ID <- rownames(Acido_all)
# Merge significant_results with Acido_all based on shared values in "Gene ID" and "Gene_acido"
merged_results_how <- merge(correlation_results_how, Acido_all, by.x = "Gene_acido", by.y = "Gene_ID", all.x = TRUE)

# Filter rows with p-value less than 0.01
significant_results_how <- subset(merged_results_how, p_value < 0.01)
```

```{r}
# save the high oxygen merged results
write.csv(merged_results_how, "acidovorax_MTX_synthase_correlation_HOW_genes.csv", row.names = TRUE)
```

Organize this by COG
```{r}
# load dataframe with the information about Acidovorax genes
acidovorax_MTX_coverage <- read.csv("acidovorax_MTX_coverage_geneinfo.csv", row.names = 1)

# Extract the desired text from the cells in the "COG function" column
acidovorax_MTX_coverage$COG_function <- str_extract(acidovorax_MTX_coverage$COG_function, ">.*<")

# Remove the leading ">" and trailing "<" characters
acidovorax_MTX_coverage$COG_function <- gsub(">", "", acidovorax_MTX_coverage$COG_function)
acidovorax_MTX_coverage$COG_function <- gsub("<", "", acidovorax_MTX_coverage$COG_function)

# Remove "/a" that is after the first letter
acidovorax_MTX_coverage$COG_function <- gsub("\\/a", "", acidovorax_MTX_coverage$COG_function)

# Remove all text following "br href" in the "COG function" column
acidovorax_MTX_coverage$COG_function <- gsub("br\\s+href.*", "", acidovorax_MTX_coverage$COG_function)

acidovorax_MTX_coverage$Gene_ID <- rownames(acidovorax_MTX_coverage)
```

```{r}
# Merge significant_results with Acido_all based on shared values in "Gene ID" and "Gene_acido"
merged_results_how_info <- merge(correlation_results_how, acidovorax_MTX_coverage, by.x = "Gene_acido", by.y = "Gene_ID", all.x = TRUE)

# Filter rows with p-value less than 0.01
significant_results_how_info <- subset(merged_results_how_info, p_value < 0.01)
```

From these results, we can see that the expression of the transcriptional regulator tetR is positively correlated with the expression of the QS synthase.Since I believe tetR can control biofilm in Acidovorax, let's do the same thing but with tetR as our query instead of the synthase. 

```{r}
# make data frame with just the Acidovorax tetR gene 2548500820
acido_tetR_how <- Acido_how[rownames(Acido_how) == "2548500820", ]

min_non_missing <- 3

# Initialize vectors to store correlation results
genes_acido_tetR_how <- character()
genes_acido <- character()
R_coefficients <- numeric()
p_values <- numeric()

# Loop through each row of acido_tetR_how
for (i in 1:nrow(acido_tetR_how)) {
  gene_values_acido_tetR_how <- as.numeric(acido_tetR_how[i, ])
  
  # Calculate correlation with each row of Acido_how
  for (j in 1:nrow(Acido_how)) {
    gene_values_acido <- as.numeric(Acido_how[j, ])
    finite_indices <- is.finite(gene_values_acido_tetR_how) & is.finite(gene_values_acido)
    
    if (sum(finite_indices) >= min_non_missing) {
      correlation <- cor.test(gene_values_acido_tetR_how[finite_indices], gene_values_acido[finite_indices])
      genes_acido_tetR_how <- c(genes_acido_tetR_how, rownames(acido_tetR_how)[i])
      genes_acido <- c(genes_acido, rownames(Acido_how)[j])
      R_coefficients <- c(R_coefficients, correlation$estimate)
      p_values <- c(p_values, correlation$p.value)
    }
  }
}

# Create dataframe for correlation results
correlation_results_tetR_how <- data.frame(
  Gene_acido_tetR_how = genes_acido_tetR_how,
  Gene_acido = genes_acido,
  R_coefficient = R_coefficients,
  p_value = p_values
)


# Merge significant_results with Acido_all based on shared values in "Gene ID" and "Gene_acido"
merged_results_how_tetR_info <- merge(correlation_results_tetR_how, acidovorax_MTX_coverage, by.x = "Gene_acido", by.y = "Gene_ID", all.x = TRUE)

# Filter rows with p-value less than 0.01
significant_results_how_tetR_info <- subset(merged_results_how_tetR_info, p_value < 0.01)
```

# correlation between 31/32 synthase and Acidovorax genes
Now I want to look at the correlation between the 31/32 synthase and all the genes in Acidovorax. 

```{r}
# LOW OXYGEN

# Select the gene from 31/32 to compare against all genes in Acidovorax
gene_Mtund_low <- "2574195741"

# Set the minimum number of non-missing values required for correlation test
min_non_missing <- 3  # Adjust this value as needed

# Initialize vectors to store correlation results
genes_mtund <- character()
genes_acido <- character()
R_coefficients <- numeric()
p_values <- numeric()

# Loop through each row of Mtund_other
for (i in 1:nrow(Acido_low)) {
  gene_values_acido <- as.numeric(Acido_low[i, ])
  gene_values_mtund <- as.numeric(Mtund_low[gene_Mtund_low, ])
  finite_indices <- is.finite(gene_values_acido) & is.finite(gene_values_mtund)
  if (sum(finite_indices) >= min_non_missing) {
    correlation <- cor.test(gene_values_acido[finite_indices], gene_values_mtund[finite_indices])
    genes_acido <- c(genes_acido, rownames(Acido_low)[i])
    genes_mtund <- c(genes_mtund, gene_Mtund_low)
    R_coefficients <- c(R_coefficients, correlation$estimate)
    p_values <- c(p_values, correlation$p.value)
  }
}

# Create dataframe for correlation results
correlation_results_low2 <- data.frame(
  Gene_mtund = genes_mtund,
  Gene_acido = genes_acido,
  R_coefficient = R_coefficients,
  p_value = p_values
)

# sort list
# Merge significant_results with Mtun_all based on shared values in "Gene ID" and "Gene_mtund"
merged_results_low2 <- merge(correlation_results_low2, Acido_all, by.x = "Gene_acido", by.y = "Gene_ID", all.x = TRUE)

# Filter rows with p-value less than 0.01
significant_results_low2 <- subset(merged_results_low2, p_value < 0.01)
```




# 31/32 anthranilate expression

31/32 anthranilate synthase/tundrenone expression: 
  
```{r}
# Load the data
coverage_anth <- read.csv("31-32_MTX_anthranilate1_coverage.csv")

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ # Default to NA character vector
   
  if(str_detect(name, "Sediment Metatranscriptome")) {
    matches <- str_match(name, "Sediment Metatranscriptome (\\d+)_([A-Z0-9]+)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name # Default case
  }
  
  # Replace dashes and spaces with underscores for all nicknames
  nickname <- str_replace_all(nickname, "[- ]", "_")
  
  return(nickname)
}

# Then apply this function to your dataframe
coverage_anth$Nickname <- sapply(coverage_anth$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage_anth <- coverage_anth %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "31-32"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage_anth, "31-32_MTX_anthranilate1_coverage_metadata.csv", row.names = TRUE)
```

Okay now my dataframe looks good and I can organize everything by the experimental details. 
Let's make a plot of the normalized coverage of pfam0765 (homoserine lactone synthetase) over time for metatranscriptome datasets aligned to the 31/32 genome. 

```{r}
# separate raw couts from normalized coverage
raw_anth <- coverage_anth %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_anth <- coverage_anth %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW_anth <- norm_anth %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
HOW_anth$coverage <- as.numeric(as.character(HOW_anth$coverage))

LOW_anth <- norm_anth %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
LOW_anth$coverage <- as.numeric(as.character(LOW_anth$coverage))

# Calculate averages for each week for the HOW data
HOW_avg_anth <- HOW_anth %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "31-32") 

# Calculate averages for each week for the LOW data
LOW_avg_anth <- LOW_anth %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE)) %>%  
  mutate(genome = "31-32") 

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW_anth, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_anth, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg_anth, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg_anth, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "31/32: anthranilate1",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

Combining synthetase and anthranilate expression in 31/32: 
```{r}
ggplot() + 
  geom_line(data = HOW_avg_anth, aes(x = week, y = log(average_coverage), color = "HOW_anth"), linetype = "dotted", size = 1) +
  geom_line(data = LOW_avg_anth, aes(x = week, y = log(average_coverage), color = "LOW_anth"), linetype = "dotted", size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = log(average_coverage), color = "HOW"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = log(average_coverage), color = "LOW"), size = 1) +
  xlab('week') +
  ylab('log(coverage)') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_anth"= "red","LOW_anth" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_anth"= "High O2: anthranilate","LOW_anth"= "Low O2: anthranilate","HOW" = "High O2: QS synthetase", "LOW" = "Low O2: QS synthetase")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

## tunJ expression
```{r}
# Load the data
coverage_tunJ <- read.csv("31-32_MTX_tunJ_coverage.csv")

# generate nicknames
generateNickname <- function(name) {
  nickname <- NA_character_ # Default to NA character vector
  
  if(str_detect(name, "Sediment Metatranscriptome")) {
    matches <- str_match(name, "Sediment Metatranscriptome (\\d+)_([A-Z0-9]+)")
    nickname <- paste0("MT", matches[,2], "_", matches[,3])
    if(str_detect(name, "Raw Count")) nickname <- paste0(nickname, "_rc")
  } else {
    nickname <- name # Default case
  }
  
  # Replace dashes and spaces with underscores for all nicknames
  nickname <- str_replace_all(nickname, "[- ]", "_")
  
  return(nickname)
}

# Then apply this function to your dataframe
coverage_tunJ$Nickname <- sapply(coverage_tunJ$sample, generateNickname)

# Add new columns: "sample_ID", "starting_oxygen", "week", "raw_count"
coverage_tunJ <- coverage_tunJ %>%
  mutate(
    sample_ID = as.numeric(str_extract(Nickname, "(?<=(MT))\\d+")), 
    starting_oxygen = case_when(
      str_detect(Nickname, "_LOW") ~ "low",
      str_detect(Nickname, "_HOW") ~ "high",
      TRUE ~ NA_character_), 
    week = as.numeric(str_extract(Nickname, "(?<=_(LOW|HOW))\\d+")), 
    raw_count = if_else(str_detect(Nickname, "_rc$"), "raw count", "normalized coverage"), 
    genome = "31-32"
    )
```

```{r}
# Save the modified dataframe
write.csv(coverage_tunJ, "31-32_MTX_tunJ_coverage_metadata.csv", row.names = TRUE)
```

Okay now my dataframe looks good and I can organize everything by the experimental details. 
Let's make a plot of the normalized coverage of pfam0765 (homoserine lactone synthetase) over time for metatranscriptome datasets aligned to the 31/32 genome. 

```{r}
# separate raw couts from normalized coverage
raw_tunJ <- coverage_tunJ %>% 
  filter(grepl("raw count", raw_count, fixed = TRUE))

norm_tunJ <- coverage_tunJ %>% 
  filter(grepl("normalized coverage", raw_count, fixed = TRUE))

# within the normalized coverage data, separate high and low oxygen conditions
HOW_tunJ <- norm_tunJ %>% 
  filter(grepl("high", starting_oxygen, fixed = TRUE))
HOW_tunJ$coverage <- as.numeric(as.character(HOW_tunJ$coverage))

LOW_tunJ <- norm_tunJ %>% 
  filter(grepl("low", starting_oxygen, fixed = TRUE))
LOW_tunJ$coverage <- as.numeric(as.character(LOW_tunJ$coverage))

# Calculate averages for each week for the HOW data
HOW_avg_tunJ <- HOW_tunJ %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE))  %>%  
  mutate(genome = "31-32") 

# Calculate averages for each week for the LOW data
LOW_avg_tunJ <- LOW_tunJ %>%
  group_by(week) %>%
  summarise(average_coverage = mean(coverage, na.rm = TRUE)) %>%  
  mutate(genome = "31-32") 

# Plot points and add average lines
ggplot() + 
  geom_point(data = HOW_tunJ, aes(x = week, y = coverage, color = "HOW"), size = 2) +
  geom_point(data = LOW_tunJ, aes(x = week, y = coverage, color = "LOW"), size = 2) +
  geom_line(data = HOW_avg_tunJ, aes(x = week, y = average_coverage, color = "HOW"), linewidth = 1) + 
  geom_line(data = LOW_avg_tunJ, aes(x = week, y = average_coverage, color = "LOW"), linewidth = 1) +
  xlab('week') +
  ylab('coverage') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW" = "red", "LOW" = "blue"),
                     name = "31/32: tunJ",  # Legend title
                     labels = c("HOW" = "High initial oxygen", "LOW" = "Low initial oxygen")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```

Combining synthetase and tunJ expression in 31/32: 
```{r}
ggplot() + 
  geom_line(data = HOW_avg_tunJ, aes(x = week, y = log(average_coverage), color = "HOW_tunJ"), linetype = "dotted", size = 1) +
  geom_line(data = LOW_avg_tunJ, aes(x = week, y = log(average_coverage), color = "LOW_tunJ"), linetype = "dotted", size = 1) +
  geom_line(data = HOW_avg, aes(x = week, y = log(average_coverage), color = "HOW"), size = 1) +
  geom_line(data = LOW_avg, aes(x = week, y = log(average_coverage), color = "LOW"), size = 1) +
  xlab('week') +
  ylab('log(coverage)') +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14)) +
  scale_color_manual(values = c("HOW_tunJ"= "red","LOW_tunJ" = "blue","HOW" = "red", "LOW" = "blue"),
                     name = "Initial oxygen tension and strain",  
                     labels = c("HOW_tunJ"= "High O2: tunJ","LOW_tunJ"= "Low O2: tunJ","HOW" = "High O2: QS synthetase", "LOW" = "Low O2: QS synthetase")) +
  geom_vline(xintercept = c(10.5)) +
  my_theme
```
Tundrenone follows the same pattern as the QS, which makes sense since tundrenone BGC is regulated by the QS system. In low oxygen conditions, tundrenone and QS are more highly expressed. 



















# Individual RNAseq files
Once downloaded and in the correct folder, we need to clean up the files: 
  
```{r}
# function to load RNAseq file and separate the columns properly
load_and_process_RNAseq_csv <- function(file_paths) {
  processed_dataframes <- list()
  for (filePath in file_paths) {
    data <- read.delim(filePath, header = TRUE, stringsAsFactors = FALSE, row.names = "LOCUS.TAG")
    data <- separate(data, GENE.ID, into = c("STUDY.ID", "ASSEMBLED", "gene_id"), sep = " ", extra = "merge", fill = "right")
    base_name <- tools::file_path_sans_ext(basename(filePath))
    processed_dataframes[[base_name]] <- data
  }
  return(processed_dataframes)
}
```
Want to apply this function to everything in the acidovorax_MTX folder that contains RNAseq/metatranscriptome data for samples aligned to the Acidovorax genome. 
```{r}
# Automatically identifying file paths of RNAseq files in the acidovorax_MT folder
folder_path <- "acidovorax_MTX/" # Ensure this path is correct
file_paths <- list.files(path = folder_path, pattern = "\\.csv$", full.names = TRUE)

# Using the function to load and process the CSV files
processed_dataframes <- load_and_process_RNAseq_csv(file_paths)


# Combine all processed dataframes into one, adding a 'SourceFile' column to each
combined_df <- do.call(rbind, lapply(names(processed_dataframes), function(name) {
  df <- processed_dataframes[[name]]
  df$SourceFile <- name
  return(df)
}))


# to make an individual dataframe
MT33_HOW06_Acidovorax_dfx <- processed_dataframes[["rnaseq_MT33_HOW06_Acidovorax"]]
```

